# HHJMs
H-likelihood based Hierarchical Joint Models

### Description

This package fits shared parameter models for the joint modeling of longitudinal data and survival data, where the longitudinal responses may be of mixed types, such as binary and continuous, and may be left censored by lower limit of quantification. For statistical inference, we consider a computationally efficient approximate likelihood method based on h-likelihood method [1]. Essentially, the h-likelihood method uses Laplace approximations to the intractable integral in the likelihood. Moreover, it can produce approximate MLEs for the mean parameters and approximate restricted maximum likelihood estimates (REML) for the variance-covariance (dispersion) parameters. 

### Usage
```r
HHJMfit ( glmeObject = list( ), survObject = list( ), long.data, surv.data, idVar, 
          itertol = 0.01, iterMax = 10, nblock = 100, Silent = T )
```
<!--
where glmeObject and survObject must be in the following format:
```r
  glmeObject <- list(fm, family, par, ran.par, disp, str_val,  CenObject)
  CenObject <- list(fm, family='binomial', par, ran.par, str_val, Cvalue, Cregime, truncated)
```
-->

##### Arguments
|           |          |
|-----------|-----------|
|glmeObject | A list, indicating the GLME models to be fitted. [Details](../blob/master/HHJMs/others.md) | 
|survObject | A list, indicating the Cox model to be fitted.  [Details](../blob/master/HHJMs/others.md) |
|long.data  | longitudinal data containing the variables named in formulas in glmeObject |
|surv.data  | survival data containing the variables named in formulas in survObject |
|idVar      | subject id |
|SIGMA      | A matrix, indicating the inital guess for the covariance matrix of the random effects. It defaults to "NULL", which means SIGMA=*I*.|
|itertol    | Convergence tolerance on the relative absolute change in log-likelihood function between successive iterations. Convergence is declared when the change is less than itertol. Default is itertol = 0.01. |
|iterMax    | The maximum number of iterations. The default value is 10. |
|nblock     | The number of intervals in the step function which is used to obtain non-parametric estimates of the baseline hazard function. The default value is 100. |
|Silent     | logical: indicating if messages about convergence success or failure should be suppressed|

##### Outputs




<!--
```r
HHJMsummary( object, digits)
```
##### Arguments
|           |          |
|-----------|-----------|
| object |  an object for which a summary is desired |
| digits |  integer indicating  the number of decimal places to be used|

##### Output
-->

### Example 
To use this package, first download the source code in 'src' to your local computer. Then call the R functions using the following R command. 

```r
# The 'src' folder has been downloaded to my desktop.
setwd("~/desktop/src")
file.sources = list.files(pattern="*.r")
sapply(file.sources, source, .GlobalEnv)

# setwd("~/myworkspace/")    # You may reset the working directory if your data are stored in a different location. 
```

```r
   glmeObject1 <- list(
    fm = z ~ 1 + sindoes + does30 + t365 + (1 | patientID),
    family='binomial',
    par="alpha",
    ran.par='b1',
    disp=NULL,
    str_val=fixef(fit1),   # the initial values are generated by fitting the model using glmer(), see fit1 below
    CenObject=NULL
  )
  
  CenObject <- list(
    fm=c ~ 1 +sint0+t365+(1|patientID),
    family='binomial',
    par='eta',
    ran.par='a',
    str_val=fixef(fit3),    # see fit3 below
    Cvalue=1.47,
    Cregime=1,
    truncated=F 
  )
  
  glmeObject2 <- list(
    fm=y ~ 1 + sindoes + t365 + t2 + (1 | patientID),
    family='normal',
    par="beta",
    ran.par='b2',
    sigma='sigma',
    str_val=fixef(fit2),   # see fit2 below
    CenObject=CenObject
  )
  
  survObject <- list(
    cox.model= obs_time~does30,
    status="event",
    sharedPar="random_effect",  
    par='lambda',
    str_val=summary(fit4)$coeff[,1]    # see fit4 below
  )
  
  testjm <- HHJMfit(glmeObject=list(glmeObject1, glmeObject2), 
                    survObject,
                    long.data, surv.data, 
                    idVar="patientID")
                    
                  
＃＃ The following models are fitted to generate initial values of the fixed parameters for HHJMfit(). 
＃  library(lme4)
＃  fit1 <- glmer(z ~ 1 + sindoes + does30 + t365 + (1 | patientID), data=long.data, family='binomial')
＃  fit2 <- lmer(y ~ 1 + sindoes + t365 + t2 + (1 | patientID), data=long.data)
＃  fit3 <- glmer(c ~ 1 +sint0+t365+(1|patientID), data=long.data, family="binomial")
＃  fitBi <- cbind(ranef(fit1)$patientID, ranef(fit2)$patientID, ranef(fit3)$patientID)
＃  nBi <- apply(fitBi, 2, function(x)scale(x, center=F,scale=T))
＃  surv.data$nb1 <- nBi[,1]; surv.data$nb2 <- nBi[,2]; surv.data$nb3 <- nBi[,3]
＃  fit4 <- coxph(Surv(obs_time, event) ~ does30+ nb1+nb2+nb3, data = surv.data)
  
```


### References
[1] Lee, Y., & Nelder, J. A. (1996). Hierarchical generalized linear models. Journal of the Royal Statistical Society. Series B (Methodological), 619-678.
